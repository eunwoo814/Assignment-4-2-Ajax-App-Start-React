<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AJAX CRUD Demo (MockAPI)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f4f4f5;
      margin: 0;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header .title {
      font-weight: 600;
      font-size: 18px;
    }
    header .subtitle {
      color: #6b7280;
      font-size: 13px;
      margin-left: 8px;
    }
    main {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }
    .card {
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }
    table tbody tr:hover {
      background: #f9fafb;
    }
    .badge-part {
      text-transform: uppercase;
      font-size: 11px;
      padding: .25rem .5rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <span class="title">HW 4-2 · AJAX CRUD</span>
      <span class="subtitle">MockAPI + Modal</span>
    </div>
    <button class="btn btn-primary btn-sm" id="btnOpenCreate">새 데이터 추가</button>
  </header>

  <main>
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <strong>사용자 목록</strong>
          <span class="text-muted ms-2" id="countLabel"></span>
        </div>
        <div class="d-flex gap-2">
          <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="이름 / 도시 / 파트 검색">
          <button class="btn btn-outline-secondary btn-sm" id="btnSearch">검색</button>
          <button class="btn btn-outline-secondary btn-sm" id="btnReload">새로고침</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:80px">id</th>
                <th>name</th>
                <th>part</th>
                <th style="width:80px">age</th>
                <th>city</th>
                <th>email</th>
                <th style="width:140px">액션</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">데이터 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalId">
          <div class="mb-3">
            <label class="form-label">이름(name)</label>
            <input type="text" class="form-control" id="modalName" placeholder="예: Alice">
          </div>
          <div class="mb-3">
            <label class="form-label">파트(part)</label>
            <select class="form-select" id="modalPart">
              <option value="web">web</option>
              <option value="server">server</option>
              <option value="ios">ios</option>
              <option value="android">android</option>
              <option value="design">design</option>
              <option value="ai">ai</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">나이(age)</label>
            <input type="number" class="form-control" id="modalAge" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">도시(city)</label>
            <input type="text" class="form-control" id="modalCity" placeholder="예: Seoul">
          </div>
          <div class="mb-3">
            <label class="form-label">이메일(email)</label>
            <input type="email" class="form-control" id="modalEmail" placeholder="name@example.com">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" id="modalSaveBtn">저장</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://6915289d84e8bd126af8d8de.mockapi.io";
    const RESOURCE = "/users";

    const rowsEl = document.getElementById("rows");
    const countLabel = document.getElementById("countLabel");
    const searchInput = document.getElementById("searchInput");
    const btnSearch = document.getElementById("btnSearch");
    const btnReload = document.getElementById("btnReload");
    const btnOpenCreate = document.getElementById("btnOpenCreate");

    const modalEl = document.getElementById("userModal");
    const modal = new bootstrap.Modal(modalEl);
    const modalTitle = document.getElementById("modalTitle");
    const modalId = document.getElementById("modalId");
    const modalName = document.getElementById("modalName");
    const modalPart = document.getElementById("modalPart");
    const modalAge = document.getElementById("modalAge");
    const modalCity = document.getElementById("modalCity");
    const modalEmail = document.getElementById("modalEmail");
    const modalSaveBtn = document.getElementById("modalSaveBtn");

    let mode = "create";

    async function httpJSON(url, options = {}) {
      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      if (!res.ok) {
        const text = await res.text();
        console.error("HTTP error", res.status, text);
        throw new Error("HTTP " + res.status);
      }
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return res.json();
      return res.text();
    }

    async function loadList(query) {
      try {
        let url = API_BASE + RESOURCE;
        if (query && query.trim() !== "") {
          const q = encodeURIComponent(query.trim());
          url += `?search=${q}`;
        }
        const list = await httpJSON(url);
        renderTable(list || []);
      } catch (e) {
        alert("목록을 불러오는 중 오류가 발생했습니다.");
      }
    }

    function renderTable(list) {
      rowsEl.innerHTML = "";
      countLabel.textContent = `총 ${list.length}건`;

      list.forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>
            <span class="badge bg-secondary badge-part">${item.part}</span>
          </td>
          <td>${item.age ?? ""}</td>
          <td>${item.city ?? ""}</td>
          <td>${item.email ?? ""}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" data-act="edit" data-id="${item.id}">편집</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${item.id}">삭제</button>
          </td>
        `;
        rowsEl.appendChild(tr);
      });
    }

    function openCreateModal() {
      mode = "create";
      modalTitle.textContent = "데이터 추가";
      modalId.value = "";
      modalName.value = "";
      modalPart.value = "web";
      modalAge.value = "";
      modalCity.value = "";
      modalEmail.value = "";
      modal.show();
    }

    function openEditModal(item) {
      mode = "edit";
      modalTitle.textContent = `데이터 수정 (id: ${item.id})`;
      modalId.value = item.id;
      modalName.value = item.name || "";
      modalPart.value = item.part || "web";
      modalAge.value = item.age ?? "";
      modalCity.value = item.city || "";
      modalEmail.value = item.email || "";
      modal.show();
    }

    async function saveFromModal() {
      const body = {
        name: modalName.value.trim(),
        part: modalPart.value,
        age: Number(modalAge.value || 0),
        city: modalCity.value.trim(),
        email: modalEmail.value.trim(),
      };

      if (!body.name || !body.email) {
        alert("이름과 이메일은 필수입니다.");
        return;
      }

      try {
        if (mode === "create") {
          await httpJSON(API_BASE + RESOURCE, {
            method: "POST",
            body: JSON.stringify(body),
          });
        } else {
          const id = modalId.value;
          if (!id) {
            alert("id가 없습니다.");
            return;
          }
          await httpJSON(`${API_BASE + RESOURCE}/${encodeURIComponent(id)}`, {
            method: "PUT",
            body: JSON.stringify(body),
          });
        }
        modal.hide();
        await loadList();
      } catch (e) {
        alert("저장 중 오류가 발생했습니다.");
      }
    }

    async function deleteById(id) {
      if (!confirm(`정말 삭제하시겠습니까? (id: ${id})`)) return;
      try {
        await httpJSON(`${API_BASE + RESOURCE}/${encodeURIComponent(id)}`, {
          method: "DELETE",
        });
        await loadList();
      } catch (e) {
        alert("삭제 중 오류가 발생했습니다.");
      }
    }

    rowsEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.dataset.id;
      if (btn.dataset.act === "edit") {
        try {
          const item = await httpJSON(`${API_BASE + RESOURCE}/${encodeURIComponent(id)}`);
          openEditModal(item);
        } catch {
          alert("데이터를 불러오는 중 오류가 발생했습니다.");
        }
      } else if (btn.dataset.act === "del") {
        deleteById(id);
      }
    });

    btnOpenCreate.onclick = openCreateModal;
    modalSaveBtn.onclick = saveFromModal;
    btnReload.onclick = () => loadList();
    btnSearch.onclick = () => loadList(searchInput.value);

    loadList();
  </script>
</body>
</html>
